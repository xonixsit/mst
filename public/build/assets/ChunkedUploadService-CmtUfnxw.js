import{c as x,a as o,o as h,r as I,A,D as N,g as b,b as C,u as P,e as j,F as R,h as T,t as m,p as E,n as V,C as B}from"./app-AKBEy-eR.js";import{r as q}from"./ChevronDownIcon-TOGbs3_L.js";import{r as Z}from"./XMarkIcon-B3pecxzB.js";function H(y,e){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"m4.5 15.75 7.5-7.5 7.5 7.5"})])}function K(y,e){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z"})])}function O(y,e){return h(),x("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor","aria-hidden":"true","data-slot":"icon"},[o("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"})])}const G={key:0,class:"fixed bottom-6 right-6 w-96 max-h-96 bg-white shadow-2xl rounded-2xl border border-gray-200 overflow-hidden z-50"},L={class:"bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4 flex items-center justify-between"},W={class:"flex items-center space-x-3"},J={key:0,class:"overflow-y-auto max-h-80 divide-y divide-gray-100"},Q={class:"flex items-start justify-between mb-2"},X={class:"flex-1"},Y={class:"text-sm font-semibold text-gray-900 truncate"},tt={class:"text-xs text-gray-500 mt-1"},et={class:"flex items-center space-x-2"},st=["onClick"],nt=["onClick"],ot={class:"w-full bg-gray-200 rounded-full h-6 overflow-hidden relative"},rt={class:"text-xs font-bold text-white drop-shadow-md"},it={key:0,class:"absolute inset-0 flex items-center justify-center"},at={class:"text-xs font-bold text-gray-700"},ct={class:"flex items-center justify-between mt-2"},lt={class:"text-xs text-gray-600 font-medium"},dt={class:"text-xs text-gray-600 font-medium"},ut={key:0,class:"flex items-center justify-between mt-2 text-xs text-gray-500"},gt={key:1,class:"px-6 py-3 bg-gray-50 text-sm text-gray-600"},xt={__name:"UploadProgressTracker",props:{uploads:{type:Array,default:()=>[]}},emits:["resume","cancel"],setup(y,{emit:e}){const c=y,n=e,r=I(!1);let d=null;A(()=>{d=setInterval(()=>{c.uploads.forEach(t=>{if(t.status==="uploading"&&t.lastProgress!==void 0){const a=(Date.now()-t.lastTime)/1e3,s=t.progress-t.lastProgress;if(t.speed=s/a*t.fileSize/1024/1024,t.speed>0){const z=100-t.progress;t.eta=z/100*t.fileSize/(t.speed*1024*1024)}t.lastProgress=t.progress,t.lastTime=Date.now()}})},1e3)}),N(()=>{d&&clearInterval(d)});const u=t=>{if(!t)return"Unknown";const a=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,s)*100)/100+" "+a[s]},i=t=>t?t.toFixed(2)+" MB/s":"0 MB/s",g=t=>!t||t===1/0?"--":t<60?Math.round(t)+"s":t<3600?Math.round(t/60)+"m":Math.round(t/3600)+"h",l=t=>({initializing:"Initializing",uploading:"Uploading",paused:"Paused",resuming:"Resuming",finalizing:"Finalizing",completed:"Completed"})[t]||t,p=t=>({initializing:"bg-blue-100 text-blue-800",uploading:"bg-purple-100 text-purple-800",paused:"bg-amber-100 text-amber-800",resuming:"bg-blue-100 text-blue-800",finalizing:"bg-indigo-100 text-indigo-800",completed:"bg-green-100 text-green-800"})[t]||"bg-gray-100 text-gray-800",w=t=>({initializing:"bg-blue-500",uploading:"bg-gradient-to-r from-purple-500 to-indigo-500",paused:"bg-amber-500",resuming:"bg-blue-500",finalizing:"bg-indigo-500",completed:"bg-green-500"})[t]||"bg-gray-500",f=t=>{n("resume",t)},v=t=>{n("cancel",t)};return(t,a)=>y.uploads.length>0?(h(),x("div",G,[o("div",L,[o("div",W,[C(P(K),{class:"w-5 h-5 text-white"}),a[1]||(a[1]=o("h3",{class:"text-white font-bold"},"Upload Progress",-1))]),o("button",{onClick:a[0]||(a[0]=s=>r.value=!r.value),class:"text-white hover:bg-white/20 p-1 rounded-lg transition-colors"},[r.value?(h(),j(P(H),{key:1,class:"w-5 h-5"})):(h(),j(P(q),{key:0,class:"w-5 h-5"}))])]),r.value?b("",!0):(h(),x("div",J,[(h(!0),x(R,null,T(y.uploads,s=>(h(),x("div",{key:s.fileId,class:"p-4 hover:bg-gray-50 transition-colors"},[o("div",Q,[o("div",X,[o("p",Y,m(s.fileName),1),o("p",tt,m(u(s.fileSize)),1)]),o("div",et,[o("span",{class:E([p(s.status),"text-xs font-bold px-2 py-1 rounded-full"])},m(l(s.status)),3),s.status==="paused"?(h(),x("button",{key:0,onClick:z=>f(s),class:"text-blue-600 hover:text-blue-700 p-1",title:"Resume upload"},[C(P(O),{class:"w-4 h-4"})],8,st)):b("",!0),s.status!=="completed"?(h(),x("button",{key:1,onClick:z=>v(s),class:"text-red-600 hover:text-red-700 p-1",title:"Cancel upload"},[C(P(Z),{class:"w-4 h-4"})],8,nt)):b("",!0)])]),o("div",ot,[o("div",{style:V({width:s.progress+"%"}),class:E([w(s.status),"h-full transition-all duration-300 flex items-center justify-center"])},[o("span",rt,m(s.progress.toFixed(1))+"% ",1)],6),s.progress<15?(h(),x("div",it,[o("span",at,m(s.progress.toFixed(1))+"%",1)])):b("",!0)]),o("div",ct,[o("span",lt,m(s.uploadedChunks)+"/"+m(s.totalChunks)+" chunks ",1),o("span",dt,m(u(s.fileSize*(s.progress/100)))+" / "+m(u(s.fileSize)),1)]),s.status==="uploading"?(h(),x("div",ut,[o("span",null,"Speed: "+m(i(s.speed)),1),o("span",null,"ETA: "+m(g(s.eta)),1)])):b("",!0)]))),128))])),r.value?(h(),x("div",gt,m(y.uploads.length)+" upload"+m(y.uploads.length!==1?"s":"")+" in progress ",1)):b("",!0)])):b("",!0)}},S=5*1024*1024,pt="DocumentUploadDB",_="uploads";class wt{static async initDB(){return new Promise((e,c)=>{const n=indexedDB.open(pt,1);n.onerror=()=>c(n.error),n.onsuccess=()=>e(n.result),n.onupgradeneeded=r=>{const d=r.target.result;d.objectStoreNames.contains(_)||d.createObjectStore(_,{keyPath:"fileId"})}})}static getEndpoint(e){return`${window.location.pathname.startsWith("/client")?"/client":"/admin"}${e}`}static async saveProgress(e,c,n,r,d){const u=await this.initDB();return new Promise((i,g)=>{const l=u.transaction([_],"readwrite");l.objectStore(_).put({fileId:e,uploadSessionId:c,uploadedChunks:n,totalChunks:r,fileData:d,timestamp:Date.now()}),l.oncomplete=()=>i(),l.onerror=()=>g(l.error)})}static async getProgress(e){const c=await this.initDB();return new Promise((n,r)=>{const i=c.transaction([_],"readonly").objectStore(_).get(e);i.onsuccess=()=>n(i.result),i.onerror=()=>r(i.error)})}static async clearProgress(e){const c=await this.initDB();return new Promise((n,r)=>{const i=c.transaction([_],"readwrite").objectStore(_).delete(e);i.onsuccess=()=>n(),i.onerror=()=>r(i.error)})}static async uploadFile(e,c,n,r,d,u,i){const g=`${Date.now()}_${Math.random().toString(36).substr(2,9)}`,l=Math.ceil(e.size/S);let p=null,w=0;try{const f=await this.getProgress(g);if(f)p=f.uploadSessionId,w=f.uploadedChunks,i("resuming");else{i("initializing");const a=this.getEndpoint("/documents/upload/init");p=(await B.post(a,{file_name:e.name,file_size:e.size,file_type:e.type,file_id:g,total_chunks:l,client_id:c,document_type:n,tax_year:r,notes:d})).data.upload_session_id}i("uploading");for(let a=w;a<l;a++){const s=a*S,z=Math.min(s+S,e.size),U=e.slice(s,z),k=new FormData;k.append("chunk",U),k.append("chunk_index",a),k.append("total_chunks",l),k.append("upload_session_id",p),k.append("file_id",g);try{const M=this.getEndpoint("/documents/upload/chunk");await B.post(M,k,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:D=>{const F=D.loaded/D.total,$=(a+F)/l*100;u($)}}),w=a+1,await this.saveProgress(g,p,w,l,{name:e.name,size:e.size,type:e.type,clientId:c,documentType:n,taxYear:r,notes:d})}catch(M){throw await this.saveProgress(g,p,w,l,{name:e.name,size:e.size,type:e.type,clientId:c,documentType:n,taxYear:r,notes:d}),M}}i("finalizing");const v=this.getEndpoint("/documents/upload/finalize"),t=await B.post(v,{upload_session_id:p,file_id:g});return await this.clearProgress(g),i("completed"),t.data}catch(f){throw console.error("Chunked upload failed:",f),i("paused"),f}}static async uploadMultipleFiles(e,c,n,r,d,u,i){const g=[];for(let l=0;l<e.length;l++){const p=e[l];try{const w=await this.uploadFile(p,c,n,r,d,f=>{const v=(l+f/100)/e.length*100;u(v,p.name)},f=>{i(f,p.name)});g.push({success:!0,file:p.name,data:w})}catch(w){g.push({success:!1,file:p.name,error:w.message})}}return g}static async getUploadSessions(){const e=await this.initDB();return new Promise((c,n)=>{const u=e.transaction([_],"readonly").objectStore(_).getAll();u.onsuccess=()=>c(u.result),u.onerror=()=>n(u.error)})}}export{wt as C,xt as _,K as r};
